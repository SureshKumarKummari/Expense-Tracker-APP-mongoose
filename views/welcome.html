<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.min.js"></script>



    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-info">
    <h1>Expense Tracker APP </h1>
    <button type="button" id="premium"class="btn btn-success">Buy premium</button>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <div class="container justify-content-center">
        <form onsubmit="handleFormSubmit(event)" class="row g-3">
            <div class="col-md-4">
                <input type="number" name="expense" id="expense" class="form-control" placeholder="Choose Expense amount" />
            </div>
        
            <div class="col-md-4">
                <input type="text" id="description" class="form-control" placeholder="Description" />
            </div>
        
            <div class="col-md-3">
                <select name="category" id="category" class="form-select" aria-label="Choose a category">
                    <option selected>Choose a category</option>
                    <option value="Food">Food</option>
                    <option value="Fuel">Fuel</option>
                    <option value="Movie">Movie</option>
                    <option value="Electricity">Electricity</option>
                </select>
            </div>
        
            <div class="col-md-1">
                <button class="btn btn-primary">Add Expense</button>
            </div>
        </form>

    </div>
    <br><br>
    <div class="container justify-content-center table-responsive" style="max-width:700px;">
    <table id="table" class="table">
        <thead class="thead-light bg-primary ">
            <tr>
                <th class="p-2 bg-primary rounded-start">Expense</th>
                <th class="p-2 bg-primary">Category</th>
                <th class="p-2 bg-primary">Description</th>
                <th class="p-2 bg-primary rounded-end">Actions</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>


<script>
   
    let token=localStorage.getItem('token');
    function handleFormSubmit(e) {
            e.preventDefault();
            let obj = {
                expense: e.target.expense.value,
                description: e.target.description.value,
                category: e.target.category.value,
            }
        axios.post('http://localhost:3000/addExpense',obj, { headers: { "Autherization": token } })
            .then(response => {
                
                addTotable(response.data);

                    })
            .catch(error => {
                console.error('Error fetching expenses:', error);
            });

        }

        function addTotable(response){
            const expense = response;
            const table = document.getElementById('table');
            const tbody = document.getElementById('table-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <form onsubmit="return false;">
                <td class="rounded-start">${expense.expense}</td>
                <td>${expense.category}</td>
                <td>${expense.description}</td>
                <td class="rounded-end">
                    <input type="hidden" name="id" value="${expense.id}">
                <button class="btn btn-danger" onclick="deleteRow(event)" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="btn btn-primary" onclick="editRow(event)" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                </td>
            </form>`;
            tbody.appendChild(tr);

            table.appendChild(tbody);
        }

//Handling Buttons 
    function deleteRow(event) {
        const row = event.target.closest('tr');
        let id= row.querySelector('input[type="hidden"]').value;
        console.log(id);
        axios.delete(`http://localhost:3000/deleteExpense/${id}`, { headers: { "Autherization": token } }).then((result) => {
            console.log("Expense Deleted!");
            row.remove();
        }).catch((error) => {
            console.log(error);
        })


    }


    function editRow(event) {
            const row = event.target.closest('tr'); // Find the closest table row

            // Extract data from the row
            const expense = row.cells[0].innerText.trim();
            const category = row.cells[1].innerText.trim();
            const description = row.cells[2].innerText.trim();
            const hiddenInput = row.querySelector('input[type="hidden"]').value;

            // Replace the row's innerHTML with empty strings
            row.innerHTML = '';

            // Create form elements for each cell and append them to the respective table cells
            const td1 = document.createElement('td');
            const expenseInput = createInputField('text', 'expense', expense);
            td1.appendChild(expenseInput);
            row.appendChild(td1);

            const td2 = document.createElement('td');
            const categoryInput = createInputField('text', 'category', category);
            td2.appendChild(categoryInput);
            row.appendChild(td2);

            const td3 = document.createElement('td');
            const descriptionInput = createInputField('text', 'description', description);
            td3.appendChild(descriptionInput);
            row.appendChild(td3);

            const td4 = document.createElement('td');
            const hiddenInputField = document.createElement('input');
            hiddenInputField.type = 'hidden';
            hiddenInputField.value = hiddenInput;
            hiddenInputField.name = 'expenseId';
            td4.appendChild(hiddenInputField);

            // Append the Save button to the last cell
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.classList.add('btn', 'btn-primary');
            saveButton.addEventListener('click', saveChanges);
            td4.appendChild(saveButton);
            row.appendChild(td4);
        }

        function createInputField(type, name, value) {
            const input = document.createElement('input');
            input.type = type;
            input.name = name;
            input.value = value;
            input.classList.add('form-control'); // Add Bootstrap class for styling
            return input;
        }


            function saveChanges(event) {
                    // Prevent the form from submitting
                    event.preventDefault();

                    const form = event.target.closest('tr'); // Find the closest table row
                    //console.log(form);
                    // Extract data from the form
                    const expense = form.querySelector('input[name="expense"]').value;
                    console.log(expense);
                    const category = form.querySelector('input[name="category"]').value;
                    const description = form.querySelector('input[name="description"]').value;
                    const expenseId = form.querySelector('input[name="expenseId"]').value;

                    // Perform validation if needed

                    // Send data to the server using Axios
                    axios.put(`http://localhost:3000/updateExpense/${expenseId}`, {
                        expense,
                        category,
                        description
                    }, { headers: { "Autherization": token } })
                        .then(response => {
                            // Handle response as needed
                            console.log('Expense updated successfully:', response.data);
                            // Refresh the page or update the row in the table with the new data
                            // For simplicity, you can reload the page
                            location.reload();
                        })
                        .catch(error => {
                            // Handle error
                            console.error('Error updating expense:', error);
                        });
                }

            function domload(){
                axios.get(`http://localhost:3000/getExpenses`,{headers:{"Autherization":token}}).then((response) => {
                    
                     for (let i = 0; i < response.data.length; i++) {
                        addTotable(response.data[i]);
                        }
                }).catch(err=>console.log(err));
            }

            window.onload = function () {
                    domload();
                };


                document.getElementById('premium').onclick=async()=>{
                    const response=await axios.get('http://localhost:3000/premiummembership', { headers: { "Autherization": token } });
                    console.log(response);
                    var options={
                        "key_id": response.data.key_id,
                        "order_id":response.data.order.id,
                        "handler": async function(response){
                            await axios.post('http://localhost:3000/transactionupdate',{
                                order_id:options.order_id,
                                payment_id:response.razorpay_payment_id},
                                { headers: { "Autherization": token } }
                            );
                            alert('you are premium member now!');
                        }
                    };
                    console.log(options);
                    const rzp=new Razorpay(options);
                    rzp.open();
                    e.preventDefault();
                    rzp.on('payment.failed',function(response){
                        console.log(response);
                        alert('Something went wrong!');
                    });

                }
                


</script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</html>

 